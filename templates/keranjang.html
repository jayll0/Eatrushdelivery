<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Keranjang — Warung {{ warung_id }}</title>
    <style>
        * { box-sizing: border-box; font-family: Segoe UI, Roboto, Arial, sans-serif }
        body { margin: 0; background: #faf7f3; color: #222 }
        .wrap { max-width: 760px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; background: #fff; padding-bottom: 120px }
        .top { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f0e7e1 }
        .back { border: 0; background: none; font-size: 20px; cursor: pointer; margin-right: 8px }
        .title { font-weight: 700; color: #8b301f }
        .list { padding: 12px; display: flex; flex-direction: column; gap: 12px }
        .card { display: flex; gap: 12px; padding: 12px; border-radius: 12px; background: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04); align-items: flex-start }
        .thumb { width: 84px; height: 72px; border-radius: 8px; object-fit: cover; background: #f2f2f2 }
        .meta { flex: 1; display: flex; flex-direction: column }
        .name { font-weight: 700; color: #7a241f }
        .price { margin-top: 6px; font-weight: 700; color: #cc3d26 }
        .note { margin-top: 8px }
        .note input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eee; font-size: 13px; }
        .controls { display: flex; flex-direction: column; gap: 8px; align-items: flex-end }
        .qtywrap { display: flex; align-items: center; gap: 8px }
        .qtybtn { width: 34px; height: 34px; border-radius: 8px; border: 0; background: #973131; color: #fff; font-weight: 700; cursor: pointer }
        .qtyval { width: 40px; text-align: center; border-radius: 6px; border: 1px solid #ddd; padding: 6px }
        .remove { background: #fff; border: 1px solid #f0d5cc; color: #973131; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .empty { padding: 28px; text-align: center; color: #666 }
        .summary { position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; width: 92%; max-width: 720px; background: #ff9d00; color: #fff; padding: 12px 16px; border-radius: 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); z-index: 100; }
        .summary .left { font-size: 14px }
        .summary .right { font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .paybtn { background: #fff; border: 0; color: #ff9d00; font-weight: 800; padding: 8px 16px; border-radius: 20px; cursor: pointer }
        .paybtn[disabled] { opacity: 0.7; cursor: not-allowed; background: #eee; color: #999; }
        .toast { position: fixed; right: 18px; bottom: 110px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 10px 14px; border-radius: 8px; z-index: 9999; display: none }
    </style>
</head>

<body>
    <div class="wrap" role="main">
        <header class="top">
            <button class="back" onclick="history.back()" aria-label="Kembali">←</button>
            <div class="title">Keranjang — Warung {{ warung_id }}</div>
        </header>

        <main id="list" class="list" aria-live="polite">
            <div class="empty">Memuat keranjang...</div>
        </main>

        <form id="checkoutForm">
            {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% endif %}
            <input type="hidden" name="warung" value="{{ warung_id }}">
        </form>
    </div>

    <div id="summary" class="summary" role="status" aria-live="polite" style="display:none">
        <div class="left">
            <div id="countText">0 item</div>
            <div style="font-size:12px;opacity:0.95">Total estimasi</div>
        </div>
        <div class="right">
            <span id="totalText" style="margin-right: 5px;">Rp 0</span>
            <button id="payBtn" class="paybtn" type="button">BAYAR</button>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="assertive"></div>

    <script>
        // --- GLOBAL ERROR HANDLER ---
        window.onerror = function (msg, url, line) {
            console.error("JS Error:", msg, line);
            return false;
        };

        // --- SCRIPT UTAMA ---
        (() => {
            // 1. DATA INJECTION
            const rawWarungId = "{{ warung_id if warung_id is defined and warung_id else '' }}";
            const WARUNG_ID = rawWarungId ? Number(rawWarungId) : null;
            // Pastikan ini merender true/false javascript
            const USER_LOGGED_IN = {{ 'true' if user else 'false' }};
            
            // Ambil CSRF Token
            const csrfInput = document.querySelector('input[name="csrf_token"]');
            const CSRF_TOKEN = csrfInput ? csrfInput.value : '';

            const URLS = {
                get: "{{ url_for('keranjang.get_server_cart') }}",
                add: "{{ url_for('keranjang.tambah_keranjang') }}",
                update: "{{ url_for('keranjang.api_update_qty') }}",
                remove: "{{ url_for('keranjang.api_remove_item') }}",
                merge: "{{ url_for('keranjang.merge_cart') }}",
                checkout: "{{ url_for('keranjang.checkout') }}",
                auth: "{{ url_for('auth.auth_page') }}"
            };

            function debounce(fn, wait = 300) {
                let t = null;
                return function (...args) {
                    if (t) clearTimeout(t);
                    t = setTimeout(() => fn.apply(this, args), wait);
                };
            }

            let listEl, summaryEl, countText, totalText, payBtn, toastEl, checkoutForm;
            let cart = [];
            const STORAGE_KEY = 'cart:warung:' + (WARUNG_ID !== null ? String(WARUNG_ID) : 'guest');

            function showToast(msg, isError = false) {
                if (!toastEl) return;
                toastEl.textContent = msg;
                toastEl.style.display = 'block';
                toastEl.style.background = isError ? 'rgba(200,0,0,0.9)' : 'rgba(0,0,0,0.8)';
                setTimeout(() => toastEl.style.display = 'none', 3500);
            }

            function formatRp(n) { return 'Rp ' + Number(n || 0).toLocaleString('id-ID'); }

            function readLocal() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return [];
                    return JSON.parse(raw) || [];
                } catch (e) { return []; }
            }

            function writeLocal(arr) {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); } catch (e) { }
            }

            // Helper fetch dengan CSRF
            async function fetchPost(url, data) {
                return fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN 
                    },
                    body: JSON.stringify(data)
                });
            }

            function render() {
                if (!listEl) return;
                listEl.innerHTML = '';

                if (!cart || cart.length === 0) {
                    listEl.innerHTML = '<div class="empty">Keranjang kosong — tambahkan item dulu.</div>';
                    if (summaryEl) summaryEl.style.display = 'none';
                    return;
                }

                cart.forEach((it, idx) => {
                    const nama = it.nama || it.name || 'Item';
                    const harga = Number(it.harga || it.price || 0);
                    const qty = Math.max(1, Number(it.qty || 1));
                    const imgUrl = it.img || "{{ url_for('static', filename='img/noimage.png') }}";
                    const note = it.note || '';

                    const card = document.createElement('div'); 
                    card.className = 'card';

                    card.innerHTML = `
                    <img src="${imgUrl}" class="thumb" onerror="this.src='https://via.placeholder.com/80?text=No+Img'">
                    <div class="meta">
                        <div class="name">${nama}</div>
                        <div class="price">${formatRp(harga)}</div>
                        <div class="note">
                            <input type="text" id="note-${idx}" placeholder="Catatan (pedas, dsb)..." value="${note}">
                        </div>
                    </div>
                    <div class="controls">
                        <div class="qtywrap">
                            <button class="qtybtn minus" type="button" data-idx="${idx}">−</button>
                            <div class="qtyval">${qty}</div>
                            <button class="qtybtn plus" type="button" data-idx="${idx}">+</button>
                        </div>
                        <button class="remove" type="button" data-idx="${idx}">Hapus</button>
                    </div>
                `;
                    listEl.appendChild(card);

                    // Event Listeners
                    card.querySelector('.minus').onclick = () => changeQty(idx, -1);
                    card.querySelector('.plus').onclick = () => changeQty(idx, +1);
                    card.querySelector('.remove').onclick = () => removeItem(idx);

                    const noteInput = card.querySelector(`#note-${idx}`);
                    noteInput.addEventListener('input', debounce((e) => {
                        // Update note lokal
                        cart[idx].note = e.target.value;
                        writeLocal(cart);
                        // Sync penuh ke server agar note tersimpan
                        scheduleMerge();
                    }, 500));
                });

                // Hitung Total
                const totals = cart.reduce((s, i) => {
                    const q = Number(i.qty || 1);
                    s.items += q;
                    s.total += (Number(i.harga || 0) * q);
                    return s;
                }, { items: 0, total: 0 });

                if (countText) countText.textContent = totals.items + ' item';
                if (totalText) totalText.textContent = formatRp(totals.total);
                if (summaryEl) summaryEl.style.display = totals.items > 0 ? 'flex' : 'none';
            }

            function changeQty(idx, delta) {
                if (!cart[idx]) return;
                const newQty = Math.max(1, Number(cart[idx].qty) + delta);
                cart[idx].qty = newQty;
                writeLocal(cart);
                render();
                
                // Kirim update ke server
                if (USER_LOGGED_IN) {
                    fetchPost(URLS.update, {
                        warung_id: WARUNG_ID,
                        id_makanan: cart[idx].id_makanan,
                        qty: newQty,
                        note: cart[idx].note || ""
                    }).catch(console.warn);
                }
            }

            function removeItem(idx) {
                if (!confirm('Hapus item ini dari keranjang?')) return;
                const removed = cart.splice(idx, 1)[0];
                writeLocal(cart);
                render();
                
                if (USER_LOGGED_IN && removed) {
                    fetchPost(URLS.remove, {
                        warung_id: WARUNG_ID,
                        id_makanan: removed.id_makanan,
                        note: removed.note || ""
                    }).catch(console.warn);
                }
            }

            const scheduleMerge = debounce(async () => {
                if (!USER_LOGGED_IN) return;
                try {
                    await fetchPost(URLS.merge, { 
                        cart: cart.map(i => ({ 
                            id_makanan: i.id_makanan, 
                            qty: i.qty, 
                            note: i.note 
                        })) 
                    });
                } catch (e) { }
            }, 1000);

            async function loadData() {
                // 1. Load Local dulu biar cepat
                cart = readLocal();
                render();

                // 2. Jika user login, ambil data terbaru dari server
                if (USER_LOGGED_IN && WARUNG_ID) {
                    try {
                        const r = await fetch(URLS.get + '?warung=' + WARUNG_ID);
                        if (r.ok) {
                            const j = await r.json();
                            if (j.success) {
                                // Struktur response harus menyesuaikan backend
                                // Asumsi: j.cart adalah list item atau object dict per warung
                                const serverCart = Array.isArray(j.cart) ? j.cart : (j.cart[String(WARUNG_ID)] || []);
                                
                                if (serverCart.length > 0) {
                                    cart = serverCart;
                                    writeLocal(cart);
                                    render();
                                }
                            }
                        }
                    } catch (e) {
                        console.log("Mode Offline / Gagal sync server");
                    }
                }
            }

            // --- LOGIKA CHECKOUT AJAX ---
            async function doCheckout() {
                if (!cart || cart.length === 0) {
                    showToast("Keranjang masih kosong", true);
                    return;
                }
                
                if (!USER_LOGGED_IN) {
                    alert("Silakan login terlebih dahulu untuk memesan.");
                    window.location.href = URLS.auth;
                    return;
                }

                payBtn.textContent = "Memproses...";
                payBtn.disabled = true;

                // 1. Siapkan Data Form
                const formData = new FormData();
                if (CSRF_TOKEN) formData.append("csrf_token", CSRF_TOKEN);
                formData.append("warung", WARUNG_ID);
                formData.append("count", cart.length);

                // Masukkan item looping index
                cart.forEach((it, idx) => {
                    formData.append(`id_${idx}`, it.id_makanan);
                    formData.append(`qty_${idx}`, it.qty);
                    formData.append(`note_${idx}`, it.note || '');
                });

                try {
                    // 2. Kirim via AJAX
                    const response = await fetch(URLS.checkout, {
                        method: "POST",
                        body: formData,
                        headers: {
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    });

                    // Tangani jika response bukan JSON (misal error HTML 500)
                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new Error("Terjadi kesalahan di server.");
                    }

                    const data = await response.json();

                    if (data.success) {
                        // Bersihkan keranjang lokal setelah sukses order
                        localStorage.removeItem(STORAGE_KEY);
                        // Redirect ke halaman pembayaran/sukses
                        window.location.href = data.redirect;
                    } else {
                        alert("Gagal Checkout:\n" + (data.message || "Stok habis atau kesalahan sistem"));
                        payBtn.textContent = "BAYAR";
                        payBtn.disabled = false;
                    }

                } catch (e) {
                    console.error("Gagal checkout:", e);
                    alert("Terjadi kesalahan jaringan.\nSilakan coba lagi.");
                    payBtn.textContent = "BAYAR";
                    payBtn.disabled = false;
                }
            }

            // --- INISIALISASI ---
            document.addEventListener("DOMContentLoaded", () => {
                listEl = document.getElementById('list');
                summaryEl = document.getElementById('summary');
                countText = document.getElementById('countText');
                totalText = document.getElementById('totalText');
                payBtn = document.getElementById('payBtn');
                toastEl = document.getElementById('toast');
                checkoutForm = document.getElementById('checkoutForm');

                if (payBtn) {
                    payBtn.addEventListener('click', doCheckout);
                }

                loadData();
            });

        })(); // <--- Penutup IIFE yang benar
    </script>
</body>
</html>