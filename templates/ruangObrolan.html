<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <title>Chat dengan {{ lawan.nama }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
    /* --- STYLE CSS --- */
    :root {
        --primary: #9a3f35;
        --bg: #fffaf0;
        --text-main: #3f3030;
        --text-muted: #999;
        --accent: #ffb347;
        --accent-text: #fff;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: "Poppins", sans-serif;
        background: var(--bg);
        height: 100vh;
        display: flex;
        justify-content: center;
        overflow: hidden;
    }

    .app {
        width: 100%;
        max-width: 360px;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: var(--bg);
        border-right: 1px solid #ddd;
        border-left: 1px solid #ddd;
    }

    /* Header */
    header {
        padding: 10px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #eee;
    }

    /* Chat Area */
    .chat-wrapper {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        background-color: #fcfcfc;
    }

    /* Bubbles */
    .msg-row {
        display: flex;
        width: 100%;
        margin-bottom: 6px;
    }

    .msg-bubble {
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 80%;
        font-size: 13px;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .msg-row.right {
        justify-content: flex-end;
    }

    .msg-bubble.me {
        background: var(--accent);
        color: #fff;
        border-bottom-right-radius: 2px;
    }

    .msg-row.left {
        justify-content: flex-start;
    }

    .msg-bubble.them {
        background: #fff;
        border: 1px solid #ddd;
        border-bottom-left-radius: 2px;
    }

    .time-label {
        font-size: 10px;
        color: #aaa;
        margin-top: 2px;
        padding: 0 5px;
    }

    /* Input Area */
    .input-section {
        padding: 10px;
        background: #fff;
        border-top: 1px solid #eee;
        display: flex;
        gap: 8px;
        align-items: flex-end;
    }

    textarea {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 18px;
        padding: 10px;
        font-family: inherit;
        resize: none;
        font-size: 13px;
        height: 45px;
    }

    textarea:focus {
        outline: 1px solid var(--primary);
    }

    button#sendBtn {
        padding: 0 16px;
        height: 45px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 18px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
    }

    button#sendBtn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .back-btn {
        position: static;   /* ‚Üê ini kuncinya */
        width: 34px;
        height: 34px;
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 40;
        text-decoration: none;
        color: #333;
        backdrop-filter: blur(4px)
    }
</style>
</head>

<body>
    <div class="app">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="window.location.href='{{ url_for('obrolan.inbox') }}'" class="back-btn">‚Üê</button>
                
                <img src="{{ lawan.GambarToko }}?v={{ range(1, 10000) | random }}" 
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/noimage.png') }}';"
                     alt="Foto Profil"
                     style="width:32px; height:32px; border-radius:50%; border:1px solid #ccc; object-fit: cover;">
                
                <span style="font-weight:600; color:var(--text-main); font-size: 14px;">{{ lawan.nama }}</span>
            </div>
        </header>
    
        <div class="chat-wrapper" id="chatWrapper">
            <div style="text-align:center; padding:20px; color:#ccc; font-size: 12px;">Memuat pesan...</div>
        </div>
    
        <section class="input-section">
            <textarea id="reasonInput" placeholder="Tulis pesan..."></textarea>
            <button id="sendBtn">Kirim</button>
        </section>
    </div>

    <input type="hidden" id="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">

    <script>
        const ID_RUANG = "{{ id_ruang }}";
        const ID_TARGET = "{{ lawan.id_target }}"; 
        const MY_ROLE = "{{ session['user']['Peran'] }}"; 
        const CSRF_TOKEN = document.getElementById('csrf_token').value;
        
        const chatWrapper = document.getElementById("chatWrapper");
        const textarea = document.getElementById("reasonInput");
        const sendBtn = document.getElementById("sendBtn");


        async function loadMessages() {
            try {

                const res = await fetch(`/chat/api/history/${ID_RUANG}?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error("Gagal load history");
                
                const chats = await res.json();
                
                chatWrapper.innerHTML = ''; 
                if(chats.length === 0) {
                    chatWrapper.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px; font-size:12px;">Belum ada pesan.<br>Sapa sekarang! üëã</div>';
                    return;
                }
                chats.forEach(msg => {
                    const isMe = (msg.Pengirim === MY_ROLE);
                    appendMessage(msg.Isi, msg.Waktu, isMe ? 'me' : 'them');
                });
            } catch (err) {
                console.error("Polling error:", err);
            }
        }


        function appendMessage(text, time, type) {
            const msgRow = document.createElement("div");
            const align = type === 'me' ? 'right' : 'left';
            
            msgRow.innerHTML = `
                <div class="msg-row ${align}">
                    <div class="msg-bubble ${type}">
                        ${text.replace(/\n/g, "<br>")}
                    </div>
                </div>
                <div class="time-label" style="text-align:${align};">
                    ${time}
                </div>
            `;
            chatWrapper.appendChild(msgRow);
            chatWrapper.scrollTop = chatWrapper.scrollHeight;
        }


        sendBtn.addEventListener("click", async () => {
            const text = textarea.value.trim();
            
            if (!text) return;
            if (!ID_TARGET || ID_TARGET === 'None') {
                alert("Error: Target chat tidak ditemukan. Silakan refresh.");
                return;
            }


            sendBtn.disabled = true;
            sendBtn.textContent = "...";
            
            const formData = new FormData();
            formData.append('isi', text);
            formData.append('id_ruang', ID_RUANG);
            formData.append('id_target', ID_TARGET);

            try {
                const headers = {};
                if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;

                const res = await fetch('/chat/api/kirim', {
                    method: 'POST',
                    body: formData,
                    headers: headers
                });
                
                const data = await res.json();

                if (res.ok && data.status === 'success') {

                    textarea.value = "";
                    

                    const msgBaru = data.data; 
                    appendMessage(msgBaru.Isi, msgBaru.Waktu, 'me');

                } else {
                    console.error("Server Error:", data);
                    alert("Gagal kirim: " + (data.message || "Error server"));
                }
            } catch (err) {
                console.error("Network Error:", err);
                alert("Error jaringan: " + err.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = "Kirim";
            }
        });


        setInterval(loadMessages, 3000);
        
        loadMessages();
    </script>
</body>
</html>